<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Graph Knowledge Admin (Offline)</title>

    <!-- 完全本地版：不依赖任何 CDN / 第三方脚本，仅使用原生 HTML/CSS/JS -->

    <style>
        :root {
            --sidebar-width: 280px;
            --props-width: 320px;
            --header-height: 56px;
            --border-color: #e5e7eb;
            --bg-color: #f9fafb;
            --primary-color: #2563eb;
            --primary-soft: #eff6ff;
        }

        * {
            box-sizing: border-box;
        }

        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #fff;
            color: #111827;
        }

        body {
            overflow: hidden;
        }

        #app-root {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* Header */
        .header {
            height: var(--header-height);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 20px;
            background: #ffffff;
            box-shadow: 0 1px 2px rgba(15, 23, 42, 0.04);
            z-index: 10;
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 17px;
            font-weight: 600;
        }

        .header-logo {
            width: 24px;
            height: 24px;
            border-radius: 999px;
            background: radial-gradient(circle at 30% 30%, #60a5fa, #1d4ed8);
        }

        .header-actions {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .btn {
            border-radius: 999px;
            border: 1px solid transparent;
            padding: 6px 14px;
            font-size: 13px;
            cursor: pointer;
            background: #f9fafb;
            color: #111827;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: background 0.15s ease, border-color 0.15s ease, box-shadow 0.15s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            color: #ffffff;
            border-color: transparent;
            box-shadow: 0 4px 10px rgba(37, 99, 235, 0.35);
        }

        .btn-primary:hover {
            filter: brightness(1.03);
        }

        .btn-ghost {
            background: transparent;
            border-color: #e5e7eb;
        }

        .btn-ghost:hover {
            background: #f3f4f6;
        }

        .avatar {
            width: 28px;
            height: 28px;
            border-radius: 999px;
            background: linear-gradient(135deg, #f97316, #ec4899);
        }

        /* Layout */
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            border-right: 1px solid var(--border-color);
            background: #ffffff;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 14px 16px 10px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 14px;
            font-weight: 600;
            color: #374151;
        }

        .sidebar-subtitle {
            padding: 0 16px 10px;
            font-size: 11px;
            color: #9ca3af;
        }

        .process-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px 10px 12px;
        }

        .process-item {
            padding: 10px 10px;
            margin: 4px 4px 6px;
            border-radius: 10px;
            cursor: pointer;
            border: 1px solid transparent;
            transition: background 0.15s ease, border-color 0.15s ease, box-shadow 0.15s ease;
        }

        .process-item:hover {
            background: #f3f4f6;
        }

        .process-item.active {
            background: #eff6ff;
            border-color: #bfdbfe;
            box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.25);
        }

        .process-title {
            font-size: 13px;
            font-weight: 500;
            color: #111827;
            margin-bottom: 4px;
        }

        .process-desc {
            font-size: 11px;
            color: #6b7280;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .tag {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 10px;
            margin-top: 6px;
            background: #eff6ff;
            color: #1d4ed8;
        }

        /* Canvas */
        .canvas-wrapper {
            flex: 1;
            position: relative;
            background: radial-gradient(circle at 0 0, #f9fafb 0, #f3f4f6 40%, #e5e7eb 120%);
            overflow: hidden;
        }

        #graph-container {
            position: relative;
            width: 100%;
            height: 100%;
        }

        #graph-nodes {
            position: absolute;
            inset: 0;
        }

        #graph-edges {
            position: absolute;
            inset: 0;
            pointer-events: none;
        }

        .canvas-toolbar {
            position: absolute;
            right: 16px;
            top: 16px;
            display: flex;
            gap: 6px;
            z-index: 20;
        }

        .btn-icon {
            width: 28px;
            height: 28px;
            border-radius: 999px;
            border: 1px solid #e5e7eb;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(15, 23, 42, 0.12);
        }

        .btn-icon:hover {
            background: #f3f4f6;
        }

        /* Node cards */
        .node-card {
            position: absolute;
            width: 190px;
            min-height: 80px;
            padding: 10px 12px 8px 12px;
            border-radius: 10px;
            background: #ffffff;
            box-shadow: 0 10px 25px rgba(15, 23, 42, 0.08);
            border: 1px solid #e5e7eb;
            cursor: default;
            transition: box-shadow 0.15s ease, transform 0.15s ease, border-color 0.15s ease;
        }

        .node-card:hover {
            transform: translateY(-1px);
            box-shadow: 0 12px 30px rgba(15, 23, 42, 0.12);
        }

        .node-selected {
            border-color: #2563eb;
            box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.5), 0 14px 40px rgba(15, 23, 42, 0.18);
        }

        .node-pill {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 6px;
            border-radius: 10px 0 0 10px;
        }

        .node-title {
            font-size: 13px;
            font-weight: 600;
            margin-left: 12px;
            color: #111827;
        }

        .node-sub {
            font-size: 10px;
            margin-left: 12px;
            margin-top: 4px;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.06em;
        }

        .node-meta {
            font-size: 10px;
            margin-left: 12px;
            margin-top: 6px;
            color: #6b7280;
        }

        .node-business .node-pill {
            background: linear-gradient(180deg, #bfdbfe, #2563eb);
        }

        .node-step .node-pill {
            background: linear-gradient(180deg, #bbf7d0, #16a34a);
        }

        .node-implementation .node-pill {
            background: linear-gradient(180deg, #e5e7eb, #4b5563);
        }

        .node-resource .node-pill {
            background: linear-gradient(180deg, #fed7aa, #f97316);
        }

        /* Right panel */
        .properties-panel {
            width: var(--props-width);
            border-left: 1px solid var(--border-color);
            background: #ffffff;
            display: flex;
            flex-direction: column;
        }

        .props-header {
            padding: 14px 16px;
            border-bottom: 1px solid var(--border-color);
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .props-content {
            flex: 1;
            padding: 16px 16px 18px;
            overflow-y: auto;
        }

        .empty-state {
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            color: #9ca3af;
            text-align: center;
        }

        .form-group {
            margin-bottom: 10px;
        }

        .form-group label {
            display: block;
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 4px;
        }

        .input, .textarea, .select {
            width: 100%;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            padding: 6px 8px;
            font-size: 12px;
            outline: none;
            transition: border-color 0.15s ease, box-shadow 0.15s ease;
            font-family: inherit;
        }

        .input:focus, .textarea:focus, .select:focus {
            border-color: #2563eb;
            box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.25);
        }

        .textarea {
            resize: vertical;
            min-height: 64px;
        }

        .form-row {
            display: flex;
            gap: 8px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 10px;
            background: #f3f4f6;
            color: #4b5563;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 999px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }
    </style>
</head>
<body>
<div id="app-root">
    <header class="header">
        <div class="header-title">
            <div class="header-logo"></div>
            <span>业务图谱管理台 (Offline)</span>
        </div>
        <div class="header-actions">
            <button class="btn btn-primary" id="btn-publish">发布到图谱 (Mock)</button>
            <button class="btn btn-ghost" id="btn-help">?</button>
            <div class="avatar"></div>
        </div>
    </header>

    <div class="main-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <span>业务流程</span>
                <button class="btn btn-ghost" id="btn-new-process" style="padding:4px 10px;font-size:11px;">新建</button>
            </div>
            <div class="sidebar-subtitle">来源：business_process / business_process_step</div>
            <div class="process-list" id="process-list"></div>
        </aside>

        <!-- Canvas -->
        <main class="canvas-wrapper">
            <div id="graph-container">
                <svg id="graph-edges"></svg>
                <div id="graph-nodes"></div>
            </div>
            <div class="canvas-toolbar">
                <button class="btn-icon" id="btn-zoom-in" title="放大">+</button>
                <button class="btn-icon" id="btn-zoom-out" title="缩小">−</button>
                <button class="btn-icon" id="btn-reset" title="重置视图">⟳</button>
            </div>
        </main>

        <!-- Properties Panel -->
        <aside class="properties-panel">
            <div class="props-header">
                <span id="props-title">节点详情</span>
                <span class="badge" id="props-type-badge">未选择</span>
            </div>
            <div class="props-content">
                <div id="props-empty" class="empty-state">
                    点击画布中的节点，查看和编辑该节点的属性。
                    <br />
                    字段设计参考：Business / Step / Implementation / DataResource。
                </div>
                <form id="props-form" style="display:none;">
                    <div class="form-group">
                        <label>节点 ID</label>
                        <input class="input" id="field-id" readonly />
                    </div>
                    <div class="form-group">
                        <label>节点名称 (label)</label>
                        <input class="input" id="field-label" />
                    </div>
                    <div class="form-group">
                        <label>描述 (description)</label>
                        <textarea class="textarea" id="field-description"></textarea>
                    </div>

                    <div id="section-step" style="display:none;">
                        <div class="form-row">
                            <div class="form-group">
                                <label>步骤顺序 (order_no)</label>
                                <input class="input" id="field-order" type="number" min="1" />
                            </div>
                            <div class="form-group">
                                <label>角色 (role)</label>
                                <select class="select" id="field-role">
                                    <option value="">-</option>
                                    <option value="user">user</option>
                                    <option value="system">system</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div id="section-implementation" style="display:none;">
                        <div class="form-group">
                            <label>系统 (system)</label>
                            <input class="input" id="field-system" />
                        </div>
                        <div class="form-group">
                            <label>代码引用 (code_ref)</label>
                            <textarea class="textarea" id="field-code-ref"></textarea>
                        </div>
                    </div>

                    <div id="section-resource" style="display:none;">
                        <div class="form-row">
                            <div class="form-group">
                                <label>资源类型 (type)</label>
                                <input class="input" id="field-resource-type" />
                            </div>
                            <div class="form-group">
                                <label>访问类型 (access_type)</label>
                                <select class="select" id="field-access-type">
                                    <option value="">-</option>
                                    <option value="read">read</option>
                                    <option value="write">write</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>所属系统 (system)</label>
                            <input class="input" id="field-resource-system" />
                        </div>
                    </div>
                </form>
            </div>
        </aside>
    </div>
</div>

<script>
(function() {
    // ==== Mock 数据：基于设计文档中的 Business / Step / Implementation / DataResource 结构 ====
    const MOCK_DATA = {
        "c_open_card": {
            id: "c_open_card",
            name: "开通月卡流程",
            channel: "app",
            description: "用户在 C 端 App 发起开通月卡的操作，涉及支付、会员状态变更等。",
            entrypoints: ["APP://open_card"],
            nodes: [
                { id: "bp_open_card", type: "business", label: "开通月卡", description: "Business.process_id = c_open_card" },
                { id: "cap_verify_identity", type: "step", label: "校验身份", order_no: 10, role: "system", description: "校验用户是否登录且账号正常" },
                { id: "cap_check_eligibility", type: "step", label: "检查开卡资格", order_no: 20, role: "system", description: "检查用户是否满足开通条件" },
                { id: "cap_create_order", type: "step", label: "创建支付订单", order_no: 30, role: "user", description: "拉起支付网关进行扣款" },
                { id: "impl_user_verify", type: "implementation", label: "UserController.verify", system: "user-service", code_ref: "user_service/controllers/auth_controller.verify", description: "TOKEN 校验" },
                { id: "impl_card_check", type: "implementation", label: "CardService.checkEligibility", system: "card-service", code_ref: "card_service/services/card.check_eligibility", description: "月卡资格校验" },
                { id: "impl_pay_create", type: "implementation", label: "PayOrder.create", system: "payment-service", code_ref: "payment_service/controllers/order.create", description: "生成支付订单" },
                { id: "res_user_db", type: "resource", label: "user_db.user", resource_type: "MySQL", system: "user-db", access_type: "read", description: "用户基础信息表" },
                { id: "res_card_db", type: "resource", label: "member_db.user_card", resource_type: "MySQL", system: "member-db", access_type: "read", description: "用户月卡表" }
            ],
            edges: [
                { source: "bp_open_card", target: "cap_verify_identity" },
                { source: "cap_verify_identity", target: "cap_check_eligibility" },
                { source: "cap_check_eligibility", target: "cap_create_order" },
                { source: "cap_verify_identity", target: "impl_user_verify" },
                { source: "cap_check_eligibility", target: "impl_card_check" },
                { source: "cap_create_order", target: "impl_pay_create" },
                { source: "impl_user_verify", target: "res_user_db" },
                { source: "impl_card_check", target: "res_card_db" }
            ]
        },
        "c_refund_order": {
            id: "c_refund_order",
            name: "订单退款流程",
            channel: "app",
            description: "用户在 App 中发起退款申请，系统进行审核并原路退回。",
            entrypoints: ["APP://refund_order"],
            nodes: [
                { id: "bp_refund", type: "business", label: "订单退款", description: "Business.process_id = c_refund_order" },
                { id: "cap_apply_refund", type: "step", label: "发起退款申请", order_no: 10, role: "user", description: "用户在 App 端提交退款原因" },
                { id: "cap_audit_refund", type: "step", label: "审核退款", order_no: 20, role: "system", description: "风控和订单规则校验" },
                { id: "impl_refund_apply", type: "implementation", label: "RefundController.apply", system: "order-service", code_ref: "order_service/controllers/refund.apply" },
                { id: "impl_refund_audit", type: "implementation", label: "RefundService.audit", system: "risk-service", code_ref: "risk_service/services/refund.audit" },
                { id: "res_order_db", type: "resource", label: "order_db.order", resource_type: "MySQL", system: "order-db", access_type: "read", description: "订单主表" }
            ],
            edges: [
                { source: "bp_refund", target: "cap_apply_refund" },
                { source: "cap_apply_refund", target: "cap_audit_refund" },
                { source: "cap_apply_refund", target: "impl_refund_apply" },
                { source: "cap_audit_refund", target: "impl_refund_audit" },
                { source: "impl_refund_apply", target: "res_order_db" },
                { source: "impl_refund_audit", target: "res_order_db" }
            ]
        }
    };

    const columnOrder = {
        business: 0,
        step: 1,
        implementation: 2,
        resource: 3
    };

    const colWidth = 230;
    const rowHeight = 120;
    const paddingX = 80;
    const paddingY = 40;

    const state = {
        currentProcessId: "c_open_card",
        selectedNodeId: null,
        zoom: 1
    };

    // DOM refs
    const processListEl = document.getElementById("process-list");
    const graphContainerEl = document.getElementById("graph-container");
    const nodesLayerEl = document.getElementById("graph-nodes");
    const edgesSvgEl = document.getElementById("graph-edges");

    const propsEmptyEl = document.getElementById("props-empty");
    const propsFormEl = document.getElementById("props-form");
    const propsTitleEl = document.getElementById("props-title");
    const propsTypeBadgeEl = document.getElementById("props-type-badge");

    const fieldId = document.getElementById("field-id");
    const fieldLabel = document.getElementById("field-label");
    const fieldDescription = document.getElementById("field-description");
    const fieldOrder = document.getElementById("field-order");
    const fieldRole = document.getElementById("field-role");
    const fieldSystem = document.getElementById("field-system");
    const fieldCodeRef = document.getElementById("field-code-ref");
    const fieldResType = document.getElementById("field-resource-type");
    const fieldAccessType = document.getElementById("field-access-type");
    const fieldResSystem = document.getElementById("field-resource-system");

    const sectionStep = document.getElementById("section-step");
    const sectionImpl = document.getElementById("section-implementation");
    const sectionRes = document.getElementById("section-resource");

    function escapeHtml(text) {
        return String(text == null ? "" : text)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#39;");
    }

    function getCurrentProcess() {
        return MOCK_DATA[state.currentProcessId];
    }

    function getNodeById(id) {
        const proc = getCurrentProcess();
        if (!proc) return null;
        return proc.nodes.find(n => n.id === id) || null;
    }

    // ==== 渲染流程列表 ====
    function renderProcessList() {
        processListEl.innerHTML = "";
        Object.values(MOCK_DATA).forEach(proc => {
            const item = document.createElement("div");
            item.className = "process-item" + (proc.id === state.currentProcessId ? " active" : "");
            item.dataset.id = proc.id;
            item.innerHTML = 
                "<div class=\"process-title\">" + escapeHtml(proc.name) + "</div>" +
                "<div class=\"process-desc\">" + escapeHtml(proc.description) + "</div>" +
                "<div class=\"tag\">" + escapeHtml(proc.id) + "</div>";
            item.addEventListener("click", function() {
                state.currentProcessId = proc.id;
                state.selectedNodeId = null;
                renderProcessList();
                renderGraph();
                clearSelection();
            });
            processListEl.appendChild(item);
        });
    }

    // ==== 渲染画布 ====
    function renderGraph() {
        const proc = getCurrentProcess();
        if (!proc) return;

        nodesLayerEl.innerHTML = "";
        edgesSvgEl.innerHTML = "";

        const rowCounter = {};
        const nodePos = {};

        proc.nodes.forEach(node => {
            const type = node.type || "business";
            const col = (type in columnOrder) ? columnOrder[type] : 0;
            const row = (rowCounter[col] || 0);
            rowCounter[col] = row + 1;

            const x = paddingX + col * colWidth;
            const y = paddingY + row * rowHeight;

            const card = document.createElement("div");
            card.className = "node-card node-" + type + (node.id === state.selectedNodeId ? " node-selected" : "");
            card.style.left = x + "px";
            card.style.top = y + "px";
            card.dataset.nodeId = node.id;

            const meta = [];
            if (type === "step") {
                if (node.order_no != null) meta.push("order_no=" + node.order_no);
                if (node.role) meta.push("role=" + node.role);
            } else if (type === "implementation") {
                if (node.system) meta.push(node.system);
            } else if (type === "resource") {
                if (node.system) meta.push(node.system);
                if (node.access_type) meta.push(node.access_type.toUpperCase());
            }

            card.innerHTML =
                '<div class="node-pill"></div>' +
                '<div class="node-title">' + escapeHtml(node.label || node.id) + '</div>' +
                '<div class="node-sub">' + escapeHtml(type.toUpperCase()) + '</div>' +
                (meta.length ? '<div class="node-meta">' + escapeHtml(meta.join(" · ")) + '</div>' : "");

            card.addEventListener("click", function(e) {
                e.stopPropagation();
                selectNode(node.id);
            });

            nodesLayerEl.appendChild(card);
            nodePos[node.id] = { x: x, y: y, width: 190, height: 80 };
        });

        // 使用 rAF 以便拿到真实大小再画连线
        requestAnimationFrame(function() {
            const parentRect = nodesLayerEl.getBoundingClientRect();
            const cards = nodesLayerEl.querySelectorAll(".node-card");
            cards.forEach(function(card) {
                const id = card.dataset.nodeId;
                const rect = card.getBoundingClientRect();
                nodePos[id] = {
                    x: rect.left - parentRect.left,
                    y: rect.top - parentRect.top,
                    width: rect.width,
                    height: rect.height
                };
            });
            drawEdges(proc.edges || [], nodePos);
        });
    }

    function drawEdges(edges, nodePos) {
        const w = graphContainerEl.clientWidth || 800;
        const h = graphContainerEl.clientHeight || 600;
        edgesSvgEl.setAttribute("width", w);
        edgesSvgEl.setAttribute("height", h);
        edgesSvgEl.setAttribute("viewBox", "0 0 " + w + " " + h);

        edges.forEach(function(edge) {
            const s = nodePos[edge.source];
            const t = nodePos[edge.target];
            if (!s || !t) return;

            const x1 = s.x + s.width;
            const y1 = s.y + s.height / 2;
            const x2 = t.x;
            const y2 = t.y + t.height / 2;
            const cx = (x1 + x2) / 2;

            const pathData = "M " + x1 + " " + y1 +
                " C " + cx + " " + y1 + ", " + cx + " " + y2 + ", " + x2 + " " + y2;

            const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
            path.setAttribute("d", pathData);
            path.setAttribute("stroke", "#9ca3af");
            path.setAttribute("stroke-width", "1.2");
            path.setAttribute("fill", "none");
            path.setAttribute("stroke-linecap", "round");

            edgesSvgEl.appendChild(path);
        });
    }

    function clearSelection() {
        state.selectedNodeId = null;
        propsFormEl.style.display = "none";
        propsEmptyEl.style.display = "flex";
        propsTypeBadgeEl.textContent = "未选择";
        const cards = nodesLayerEl.querySelectorAll(".node-card");
        cards.forEach(function(card) {
            card.classList.remove("node-selected");
        });
    }

    function selectNode(id) {
        state.selectedNodeId = id;
        const node = getNodeById(id);
        if (!node) {
            clearSelection();
            return;
        }

        const cards = nodesLayerEl.querySelectorAll(".node-card");
        cards.forEach(function(card) {
            if (card.dataset.nodeId === id) card.classList.add("node-selected");
            else card.classList.remove("node-selected");
        });

        propsEmptyEl.style.display = "none";
        propsFormEl.style.display = "block";

        fieldId.value = node.id;
        fieldLabel.value = node.label || "";
        fieldDescription.value = node.description || "";

        sectionStep.style.display = node.type === "step" ? "block" : "none";
        sectionImpl.style.display = node.type === "implementation" ? "block" : "none";
        sectionRes.style.display = node.type === "resource" ? "block" : "none";

        if (node.type === "step") {
            fieldOrder.value = node.order_no != null ? node.order_no : "";
            fieldRole.value = node.role || "";
        }
        if (node.type === "implementation") {
            fieldSystem.value = node.system || "";
            fieldCodeRef.value = node.code_ref || "";
        }
        if (node.type === "resource") {
            fieldResType.value = node.resource_type || "";
            fieldAccessType.value = node.access_type || "";
            fieldResSystem.value = node.system || "";
        }

        propsTitleEl.textContent = node.label || node.id;
        propsTypeBadgeEl.textContent = node.type || "node";
    }

    // ==== 表单事件：回写到 Mock 数据并更新节点卡片 ====
    function bindFormEvents() {
        fieldLabel.addEventListener("input", function() {
            const node = getNodeById(state.selectedNodeId);
            if (!node) return;
            node.label = fieldLabel.value;
            const card = nodesLayerEl.querySelector('.node-card[data-node-id="' + node.id + '"] .node-title');
            if (card) card.textContent = fieldLabel.value || node.id;
            propsTitleEl.textContent = fieldLabel.value || node.id;
        });

        fieldDescription.addEventListener("input", function() {
            const node = getNodeById(state.selectedNodeId);
            if (!node) return;
            node.description = fieldDescription.value;
        });

        fieldOrder.addEventListener("input", function() {
            const node = getNodeById(state.selectedNodeId);
            if (!node) return;
            const v = parseInt(fieldOrder.value, 10);
            node.order_no = isNaN(v) ? null : v;
        });

        fieldRole.addEventListener("change", function() {
            const node = getNodeById(state.selectedNodeId);
            if (!node) return;
            node.role = fieldRole.value || null;
            renderGraph();
        });

        fieldSystem.addEventListener("input", function() {
            const node = getNodeById(state.selectedNodeId);
            if (!node) return;
            node.system = fieldSystem.value;
            renderGraph();
        });

        fieldCodeRef.addEventListener("input", function() {
            const node = getNodeById(state.selectedNodeId);
            if (!node) return;
            node.code_ref = fieldCodeRef.value;
        });

        fieldResType.addEventListener("input", function() {
            const node = getNodeById(state.selectedNodeId);
            if (!node) return;
            node.resource_type = fieldResType.value;
        });

        fieldAccessType.addEventListener("change", function() {
            const node = getNodeById(state.selectedNodeId);
            if (!node) return;
            node.access_type = fieldAccessType.value || null;
            renderGraph();
        });

        fieldResSystem.addEventListener("input", function() {
            const node = getNodeById(state.selectedNodeId);
            if (!node) return;
            node.system = fieldResSystem.value;
            renderGraph();
        });
    }

    // ==== 画布缩放（简单使用 CSS transform） ====
    function applyZoom() {
        const z = state.zoom;
        nodesLayerEl.style.transform = 'scale(' + z + ')';
        nodesLayerEl.style.transformOrigin = '0 0';
        edgesSvgEl.style.transform = 'scale(' + z + ')';
        edgesSvgEl.style.transformOrigin = '0 0';
    }

    function initToolbar() {
        document.getElementById("btn-zoom-in").addEventListener("click", function() {
            state.zoom = Math.min(2.0, state.zoom + 0.1);
            applyZoom();
        });
        document.getElementById("btn-zoom-out").addEventListener("click", function() {
            state.zoom = Math.max(0.5, state.zoom - 0.1);
            applyZoom();
        });
        document.getElementById("btn-reset").addEventListener("click", function() {
            state.zoom = 1;
            applyZoom();
        });

        graphContainerEl.addEventListener("click", function() {
            clearSelection();
        });

        document.getElementById("btn-publish").addEventListener("click", function() {
            alert("[Mock] 将当前 business_process / steps / implementations / data_resources 同步到 Neo4j 图谱。");
        });

        document.getElementById("btn-help").addEventListener("click", function() {
            alert("这是一个完全本地的静态原型，用于演示：左侧流程列表 + 中间流程图画布 + 右侧节点属性编辑。后续可以替换为真实 API 请求与保存逻辑。");
        });
    }

    // ==== 初始化 ====
    function init() {
        renderProcessList();
        renderGraph();
        bindFormEvents();
        initToolbar();
        applyZoom();
    }

    window.addEventListener("load", init);
})();
</script>
</body>
</html>
