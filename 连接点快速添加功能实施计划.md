# 连接点快速添加功能实施计划

> 时间：2025-11-22  
> 功能：在节点的四个连接点旁添加 `+` 按钮，点击后快速选择并添加下一个节点，自动创建连线

---

## 功能需求

### 用户故事
作为用户，我希望能够：
1. 在节点的连接点旁看到 `+` 按钮（悬停时显示）
2. 点击 `+` 按钮后弹出节点选择器
3. 选择节点后自动添加到画布并创建连线
4. 新节点的位置根据连接点方向自动计算

### 交互设计
- `+` 按钮在节点悬停时显示，位于连接点旁边
- 点击后弹出Modal，显示可选节点列表
- 根据当前节点类型和连接点方向智能推荐节点类型
- 选择节点后自动关闭Modal，添加节点和连线

---

## 技术方案

### 1. AllSidesNode 组件修改

**位置**：`frontend/src/pages/BusinessLibraryPage.tsx`

**需要添加**：
```typescript
// 在AllSidesNode组件中添加
const [showAddButtons, setShowAddButtons] = useState(false)
const [addNodeModal, setAddNodeModal] = useState<{
  visible: boolean
  direction: 'top' | 'right' | 'bottom' | 'left'
  sourceHandle: string
} | null>(null)

// 四个方向的+按钮
<button 
  onClick={() => handleAddClick('right', 'r-out')}
  style={{
    position: 'absolute',
    right: -20,
    top: '50%',
    transform: 'translateY(-50%)',
    // ... 样式
  }}
>
  +
</button>
```

### 2. 节点选择器 Modal

**组件结构**：
```typescript
interface QuickAddModalProps {
  visible: boolean
  nodeType: 'step' | 'implementation' | 'data'
  direction: 'top' | 'right' | 'bottom' | 'left'
  onSelect: (node: any) => void
  onCancel: () => void
}
```

**智能推荐规则**：
- **步骤节点**：
  - 右侧：推荐步骤（流程）、实现（执行）
  - 下方：推荐实现（执行）
  - 其他方向：推荐步骤
- **实现节点**：
  - 所有方向：推荐数据资源（访问）
- **数据资源节点**：
  - 不显示+按钮（终点节点）

### 3. 添加节点逻辑

**位置计算**：
```typescript
const calculateNewNodePosition = (
  sourceNode: Node,
  direction: 'top' | 'right' | 'bottom' | 'left'
) => {
  const offset = 300 // 节点间距
  const basePos = sourceNode.position
  
  switch (direction) {
    case 'right':
      return { x: basePos.x + offset, y: basePos.y }
    case 'bottom':
      return { x: basePos.x, y: basePos.y + 200 }
    case 'left':
      return { x: basePos.x - offset, y: basePos.y }
    case 'top':
      return { x: basePos.x, y: basePos.y - 200 }
  }
}
```

**连线创建**：
```typescript
const createEdge = (
  sourceNodeId: string,
  targetNodeId: string,
  sourceHandle: string,
  targetHandle: string,
  edgeType: 'process' | 'step-impl' | 'impl-dr'
) => {
  return {
    id: `edge-${Date.now()}`,
    source: sourceNodeId,
    target: targetNodeId,
    sourceHandle,
    targetHandle,
    data: { kind: edgeType },
    style: { stroke: getEdgeColor(edgeType) }
  }
}
```

---

## 实施步骤

### 步骤1：修改 AllSidesNode 组件

1. 添加状态管理
2. 添加四个方向的 `+` 按钮
3. 实现点击处理函数

### 步骤2：创建 QuickAddModal 组件

1. 创建Modal组件
2. 实现节点列表展示
3. 实现搜索和过滤

### 步骤3：实现添加逻辑

1. 在父组件中添加处理函数
2. 计算新节点位置
3. 创建节点和连线
4. 更新状态

### 步骤4：测试验证

1. 测试各种节点类型的添加
2. 测试不同方向的添加
3. 测试连线是否正确

---

## UI 设计

### + 按钮样式
```css
{
  width: 20px,
  height: 20px,
  borderRadius: '50%',
  background: '#1677ff',
  color: '#fff',
  border: 'none',
  cursor: 'pointer',
  fontSize: 16,
  display: 'flex',
  alignItems: 'center',
  justifyContent: 'center',
  boxShadow: '0 2px 4px rgba(0,0,0,0.2)',
  opacity: showAddButtons ? 1 : 0,
  transition: 'opacity 0.2s',
  zIndex: 10
}
```

### Modal 样式
- 宽度：600px
- 高度：400px
- 显示节点列表（带搜索）
- 每个节点显示：名称、类型、系统

---

## 注意事项

1. **性能优化**：
   - 使用 `React.memo` 避免不必要的重渲染
   - 节点列表使用虚拟滚动（如果数量很大）

2. **用户体验**：
   - `+` 按钮只在悬停时显示，避免遮挡
   - Modal 支持键盘操作（ESC关闭，Enter确认）
   - 添加节点后自动选中新节点

3. **边界情况**：
   - 数据资源节点不显示 `+` 按钮
   - 如果没有可选节点，显示提示信息
   - 避免创建重复的连线

---

## 后续优化

1. **智能布局**：
   - 检测画布上已有节点，避免重叠
   - 自动调整新节点位置

2. **批量添加**：
   - 支持一次添加多个节点
   - 自动创建链式连接

3. **模板功能**：
   - 保存常用的节点组合
   - 一键添加模板

---

**准备开始实施！**
