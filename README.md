# Graph Knowledge - 业务知识图谱对话系统

基于 **LLM + Neo4j 图数据库** 的业务知识问答与可视化管理平台。通过自然语言对话探索企业业务流程、接口实现和数据资源之间的关联关系。

## 🎯 核心能力

| 能力          | 说明                                           |
|-------------|----------------------------------------------|
| **智能对话问答**  | 四类 Agent（知识问答、日志排查、智能测试、永策Pro智能助手），支持多轮对话和流式输出         |
| **知识图谱可视化** | 通过 ReactFlow 实现业务流程画布的拖拽编辑、关系连接、一键同步到 Neo4j  |
| **骨架自动生成**  | CrewAI 三 Agent 协作（数据分析师→流程设计师→技术架构师）生成业务流程骨架 |
| **代码检索**    | 基于 MCP 协议 (acemcp) 实现代码级实现细节检索               |
| **影响面分析**   | 追踪接口/数据资源的业务使用范围和上下游依赖                       |

---

## 📐 系统整体架构

```
┌──────────────────────────────────────────────────────────────────────────────────────────┐
│                              前端 (React 18 + TypeScript + Vite)                          │
├──────────────────────────────────────────────────────────────────────────────────────────┤
│  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐          │
│  │  HomePage  │  │  ChatPage  │  │  Business  │  │  Resource  │  │  LLMModel  │          │
│  │   仪表盘    │  │ AI对话问答  │  │  Library   │  │  Library   │  │   Manage   │          │
│  │            │  │ (WebSocket)│  │(ReactFlow) │  │  资源管理   │  │  模型配置   │          │
│  └────────────┘  └────────────┘  └────────────┘  └────────────┘  └────────────┘          │
│                                                                                           │
│  ┌─────────────────────────────────────────────────────────────────────────────────────┐ │
│  │  组件层: Ant Design 5 (UI) │ @xyflow/react (流程图) │ Markdown Preview (对话渲染)    │ │
│  └─────────────────────────────────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────────────────────────────────┘
                                            │
                        ┌───────────────────┴───────────────────┐
                        │ REST API                   WebSocket  │
                        ▼                                       ▼
┌──────────────────────────────────────────────────────────────────────────────────────────┐
│                                   后端 (FastAPI + Uvicorn)                                │
├──────────────────────────────────────────────────────────────────────────────────────────┤
│                                        API Layer (v1)                                     │
│  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐    │
│  │ llm_chat  │ │llm_skeleton│ │ llm_models│ │   graph   │ │  canvas   │ │  files    │    │
│  │ 流式对话WS │ │ 骨架生成WS │ │ 模型管理   │ │ 图查询API │ │ 画布保存  │ │ 文件上传  │    │
│  └───────────┘ └───────────┘ └───────────┘ └───────────┘ └───────────┘ └───────────┘    │
├──────────────────────────────────────────────────────────────────────────────────────────┤
│                                      Service Layer                                        │
│  ┌─────────────────────────────────┐  ┌─────────────────────────────────────────────┐    │
│  │         Chat Services           │  │            Graph Services                   │    │
│  │ ┌───────────┐ ┌───────────────┐ │  │ ┌─────────────┐ ┌────────────────────────┐  │    │
│  │ │chat_service│ │history_service│ │  │ │graph_service│ │graph_sync_service     │  │    │
│  │ │  流式编排   │ │ 会话历史管理  │ │  │ │ Neo4j查询   │ │ SQLite→Neo4j 同步     │  │    │
│  │ └───────────┘ └───────────────┘ │  │ └─────────────┘ └────────────────────────┘  │    │
│  │ ┌───────────┐ ┌───────────────┐ │  └─────────────────────────────────────────────┘    │
│  │ │ multimodal│ │document_parser│ │  ┌─────────────────────────────────────────────┐    │
│  │ │ 多模态处理 │ │  文档解析     │ │  │         Resource Services                   │    │
│  │ └───────────┘ └───────────────┘ │  │ ┌─────────────┐ ┌─────────────────────────┐ │    │
│  └─────────────────────────────────┘  │ │canvas_service│ │resource_node_service   │ │    │
│  ┌─────────────────────────────────┐  │ │  画布处理    │ │    资源节点管理         │ │    │
│  │       Skeleton Services         │  │ └─────────────┘ └─────────────────────────┘ │    │
│  │ ┌─────────────────────────────┐ │  └─────────────────────────────────────────────┘    │
│  │ │     skeleton_service        │ │  ┌─────────────────────────────────────────────┐    │
│  │ │   CrewAI 骨架生成编排        │ │  │           Other Services                    │    │
│  │ └─────────────────────────────┘ │  │ ┌─────────────────┐ ┌─────────────────────┐ │    │
│  └─────────────────────────────────┘  │ │ai_model_service │ │  coding_service     │ │    │
│                                        │ └─────────────────┘ └─────────────────────┘ │    │
│                                        └─────────────────────────────────────────────┘    │
├──────────────────────────────────────────────────────────────────────────────────────────┤
│                                     LLM Agent Layer                                       │
│  ┌────────────────────────────────────────────────────────────────────────────────────┐  │
│  │                    AgentRegistry (单例 + 懒加载 + 配置变更检测)                       │  │
│  │  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────────────────┐      │  │
│  │  │  knowledge_qa    │  │ log_troubleshoot │  │   intelligent_testing        │      │  │
│  │  │  业务知识问答     │  │   日志排查        │  │   智能测试 (三阶段)            │      │  │
│  │  │  (16个工具)       │  │   (12个工具)      │  │   analysis→plan→generate     │      │  │
│  │  └──────────────────┘  └──────────────────┘  └──────────────────────────────┘      │  │
│  └────────────────────────────────────────────────────────────────────────────────────┘  │
│  ┌────────────────────────────────────────────────────────────────────────────────────┐  │
│  │                            CrewAI (骨架生成 Multi-Agent)                            │  │
│  │         数据分析师 ──────▶ 流程设计师 ──────▶ 技术架构师                              │  │
│  └────────────────────────────────────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────────────────────────────────────┘
                        │                     │                      │
        ┌───────────────┴──────┐              │              ┌───────┴───────────────┐
        ▼                      ▼              ▼              ▼                       ▼
┌────────────────┐  ┌────────────────┐  ┌────────────────┐  ┌────────────────────────────┐
│    SQLite      │  │  Checkpointer  │  │     Neo4j      │  │     External Services      │
│  (元数据存储)   │  │ (对话历史持久化) │  │   (知识图谱)    │  │                            │
├────────────────┤  ├────────────────┤  ├────────────────┤  │ ┌────────────────────────┐ │
│ • Business     │  │ • thread_id    │  │ • Business     │  │ │    LLM Providers       │ │
│ • Step         │  │ • checkpoints  │  │ • Step         │  │ │ ┌────────────────────┐ │ │
│ • Impl         │  │ • messages     │  │ • Impl         │  │ │ │ LiteLLM 模式       │ │ │
│ • DataResource │  │                │  │ • DataResource │  │ │ │ • OpenAI/Azure     │ │ │
│ • *Edge/*Link  │  │ AsyncSqlite    │  │ • NEXT/EXEC..  │  │ │ │ • Ollama/本地LLM   │ │ │
│ • Conversation │  │   Saver        │  │                │  │ │ └────────────────────┘ │ │
│ • AIModel      │  │                │  │                │  │ │ ┌────────────────────┐ │ │
└────────────────┘  └────────────────┘  └────────────────┘  │ │ │ 自定义网关模式      │ │ │
                                                             │ │ │ • NewAPI 等网关    │ │ │
                                                             │ │ └────────────────────┘ │ │
                                                             │ └────────────────────────┘ │
                                                             │ ┌────────────────────────┐ │
                                                             │ │    MCP Server (acemcp) │ │
                                                             │ │    代码检索服务         │ │
                                                             │ └────────────────────────┘ │
                                                             └────────────────────────────┘
```

---

## 功能模块详解

### 1. AI 对话问答 (`/chat`)

通过自然语言与知识图谱交互，支持四类 Agent。

#### 1.0 永策Pro智能助手 (`opdoc_qa`)

**永策Pro智能助手**（`agent_type = "opdoc_qa"`）用于对永策Pro平台的企业文档知识库进行问答。

特点：

- **检索引擎**：基于 LightRAG 的混合检索（向量 + 知识图谱）
- **首次对话预检索**：首次提问会先执行轻量预检索（naive 模式）获取背景信息，再进入对话编排
- **工具集**：提供 1 个企业知识库检索工具 `search_yongce_docs`（支持 `naive/local/global/hybrid/mix` 模式）

分流入口：`backend/app/api/v1/llm_chat.py` 中 `agent_type == "opdoc_qa"` 分支。

#### 1.1 Chat Agent 架构

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                  Chat Agent 架构                                         │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                          │
│  ┌────────────────────────────────────────────────────────────────────────────────────┐ │
│  │                        AgentRegistry (单例)                                         │ │
│  │  • 懒加载 + LLM配置变更检测 + 预热支持                                                │ │
│  │  • 缓存 LLM 实例和工具列表，减少重复初始化开销                                         │ │
│  └────────────────────────────────┬───────────────────────────────────────────────────┘ │
│                                   │                                                      │
│         ┌─────────────────────────┼─────────────────────────┐                           │
│         ▼                         ▼                         ▼                           │
│  ┌──────────────────┐     ┌──────────────────┐     ┌────────────────────────┐          │
│  │   knowledge_qa   │     │ log_troubleshoot │     │  intelligent_testing   │          │
│  │   业务知识问答    │     │     日志排查      │     │      智能测试           │          │
│  └────────┬─────────┘     └────────┬─────────┘     └───────────┬────────────┘          │
│           │                        │                           │                        │
│           ▼                        ▼                           ▼                        │
│  ┌──────────────────┐     ┌──────────────────┐     ┌────────────────────────┐          │
│  │    16 个工具      │     │    12 个工具      │     │    三阶段工作流         │          │
│  │ • 实体发现 (4)    │     │ • 日志查询 (1)    │     │                        │          │
│  │ • 上下文 (3)      │     │ • 代码检索 (5)    │     │ ┌────────────────────┐ │          │
│  │ • 影响面 (2)      │     │ • 业务理解 (4)    │     │ │ Phase 1: analysis  │ │          │
│  │ • 图拓扑 (2)      │     │ • 数据库 (2)      │     │ │ 需求分析            │ │          │
│  │ • 代码检索 (5)    │     │                  │     │ ├────────────────────┤ │          │
│  └──────────────────┘     └──────────────────┘     │ │ Phase 2: plan      │ │          │
│                                                     │ │ 用例规划            │ │          │
│                                                     │ ├────────────────────┤ │          │
│                                                     │ │ Phase 3: generate  │ │          │
│                                                     │ │ 用例生成            │ │          │
│                                                     │  每阶段独立 thread_id   │          │
│                                                     └────────────────────────┘          │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

#### 1.2 对话数据流

```
用户提问 ──WebSocket──▶ llm_chat API ──▶ AgentRegistry.get_agent()
                                              │
                                              ▼
                                     ┌─────────────────┐
                                     │  LangGraph Agent │◀──── System Prompt
                                     │  (ReAct Loop)    │       (configs.py)
                                     └────────┬────────┘
                                              │
            ┌─────────────────────────────────┼─────────────────────────────────┐
            ▼                                 ▼                                 ▼
    ┌───────────────┐                ┌───────────────┐                ┌───────────────┐
    │ Discovery Tool│                │ Context Tool  │                │  Code Tool    │
    │ (SQLite + LLM)│                │ (Neo4j 图遍历)│                │ (MCP 代码检索)│
    └───────────────┘                └───────────────┘                └───────────────┘
            │                                 │                                 │
            └─────────────────────────────────┼─────────────────────────────────┘
                                              ▼
                                     ┌─────────────────┐
                                     │   流式响应生成   │
                                     │ (思考+工具+回答) │
                                     └────────┬────────┘
                                              │
                                              ▼
                               WebSocket 推送给前端 ChatPage
```

#### 1.3 工具集

| 类别        | 工具                                   | 说明          |
|-----------|--------------------------------------|-------------|
| **实体发现**  | `search_businesses`                  | 搜索业务流程      |
|           | `search_steps`                       | 搜索业务步骤      |
|           | `search_implementations`             | 搜索接口/实现     |
|           | `search_data_resources`              | 搜索数据资源      |
| **上下文获取** | `get_business_context`               | 获取业务流程完整上下文 |
|           | `get_implementation_context`         | 获取接口依赖与调用关系 |
|           | `get_resource_context`               | 获取数据资源访问情况  |
| **影响面分析** | `get_implementation_business_usages` | 接口的业务使用范围   |
|           | `get_resource_business_usages`       | 数据资源的业务使用范围 |
| **图拓扑**   | `get_neighbors`                      | 获取节点邻居      |
|           | `get_path_between_entities`          | 查找两实体间路径    |
| **代码检索**  | `search_code_context`                | MCP 代码级检索   |
|           | `grep_code`                          | 代码内容搜索      |
|           | `list_directory`                     | 目录列表        |
|           | `read_file`                          | 文件读取        |
|           | `read_file_range`                    | 文件范围读取      |
| **日志查询**  | `search_logs`                        | 企业日志 API 查询 |
| **数据库查询** | `get_table_schema`                   | 获取表结构       |
|           | `query_database`                     | 执行 SQL 查询   |
| **企业知识库检索** | `search_yongce_docs`               | 永策Pro企业知识库检索（支持 `naive/local/global/hybrid/mix` 模式） |

---

### 2. 骨架自动生成

通过 CrewAI 三 Agent 协作自动生成业务流程骨架。

#### 2.1 骨架生成流程架构

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                            骨架生成 Multi-Agent 流程                                     │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                          │
│  用户输入                                                                                │
│  ┌───────────────────────────────────────────────┐                                      │
│  │ • 业务名称 + 业务描述                           │                                      │
│  │ • 结构化日志（可选）                            │                                      │
│  │ • API 抓包数据（可选）                          │                                      │
│  │ • 已知系统/数据资源列表（可选）                  │                                      │
│  └────────────────────┬──────────────────────────┘                                      │
│                       ▼                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐    │
│  │                      Agent 1: 数据分析师                                         │    │
│  │  • 从日志/抓包数据提取系统、接口、数据资源线索                                      │    │
│  │  • 输出: DataAnalysisResult (系统列表、接口列表、资源列表)                         │    │
│  └─────────────────────────────────┬───────────────────────────────────────────────┘    │
│                                    ▼ (WebSocket 流式输出)                                │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐    │
│  │                      Agent 2: 流程设计师                                         │    │
│  │  • 将业务描述 + 技术线索转化为流程步骤                                             │    │
│  │  • 输出: FlowDesignResult (步骤列表、步骤边关系、分支结构)                         │    │
│  └─────────────────────────────────┬───────────────────────────────────────────────┘    │
│                                    ▼ (WebSocket 流式输出)                                │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐    │
│  │                      Agent 3: 技术架构师                                         │    │
│  │  • 完善实现细节、数据资源访问关系                                                  │    │
│  │  • 输出: ProcessSkeleton (完整骨架 JSON)                                         │    │
│  └─────────────────────────────────┬───────────────────────────────────────────────┘    │
│                                    ▼                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐    │
│  │                      骨架 → 画布数据转换                                          │    │
│  │                 ProcessSkeleton → SaveProcessCanvasRequest                       │    │
│  └─────────────────────────────────┬───────────────────────────────────────────────┘    │
│                                    ▼                                                     │
│                           前端画布预览 → 确认保存                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

### 3. 业务画布编辑器 (`/business`)

基于 ReactFlow 的可视化业务流程编辑器。

#### 3.1 画布同步到 Neo4j 架构

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                          画布数据同步到 Neo4j 流程                                       │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                          │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐    │
│  │                  ReactFlow 画布 (BusinessLibraryPage)                            │    │
│  │   ┌─────────┐      ┌─────────┐      ┌─────────┐      ┌─────────┐                │    │
│  │   │  Step   │─────▶│  Step   │─────▶│  Impl   │─────▶│Resource │                │    │
│  │   │  节点   │      │  节点   │      │  节点   │      │  节点   │                │    │
│  │   └─────────┘      └─────────┘      └─────────┘      └─────────┘                │    │
│  └─────────────────────────────────────┬───────────────────────────────────────────┘    │
│                                        │ 保存画布                                        │
│                                        ▼                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐    │
│  │                          canvas_service.py                                       │    │
│  │  • 解析节点位置、连线关系                                                         │    │
│  │  • 提取 canvas_node_ids: {step_ids, impl_ids, resource_ids}                     │    │
│  └─────────────────────────────────────┬───────────────────────────────────────────┘    │
│                                        ▼                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐    │
│  │                            SQLite 存储                                           │    │
│  │   ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐              │    │
│  │   │     Business     │  │ ProcessStepEdge  │  │StepImplementation│              │    │
│  │   │  canvas_node_ids │  │   from → to      │  │   step → impl    │              │    │
│  │   │   sync_status    │  └──────────────────┘  └──────────────────┘              │    │
│  │   └──────────────────┘                                                           │    │
│  └─────────────────────────────────────┬───────────────────────────────────────────┘    │
│                                        │ 一键同步                                        │
│                                        ▼                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐    │
│  │                       graph_sync_service.py                                      │    │
│  │                                                                                  │    │
│  │  1. 更新 sync_status = "syncing"                                                │    │
│  │  2. 读取 canvas_node_ids 解析节点 ID 列表                                        │    │
│  │  3. 创建约束 (Business/Step/Impl/Resource 唯一性)                                │    │
│  │  4. MERGE 节点：Business → Step → Implementation → DataResource                  │    │
│  │  5. MERGE 关系：NEXT, EXECUTED_BY, ACCESSES_RESOURCE, IMPL_CALL                  │    │
│  │  6. 更新 sync_status = "synced" / "failed"                                      │    │
│  └─────────────────────────────────────┬───────────────────────────────────────────┘    │
│                                        ▼                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐    │
│  │                              Neo4j 图谱                                          │    │
│  │                                                                                  │    │
│  │      (Business)──[:START_AT]──▶(Step)──[:NEXT]──▶(Step)                         │    │
│  │                                   │                                              │    │
│  │                            [:EXECUTED_BY]                                        │    │
│  │                                   ▼                                              │    │
│  │                           (Implementation)──[:IMPL_CALL]──▶(Impl)                │    │
│  │                                   │                                              │    │
│  │                          [:ACCESSES_RESOURCE]                                    │    │
│  │                                   ▼                                              │    │
│  │                            (DataResource)                                        │    │
│  └─────────────────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

### 4. 资源库管理 (`/resources`)

管理四类资源节点：

| 资源类型     | 页面                          | 说明         |
|----------|-----------------------------|-------------|
| **业务流程** | `BusinessProcessPage`       | 顶层业务对象     |
| **步骤**   | `StepLibraryPage`           | 业务环节/节点    |
| **实现**   | `ImplementationLibraryPage` | 技术接口/服务    |
| **数据资源** | `DataResourceLibraryPage`   | 数据库表/缓存/文件 |

---

### 5. LLM 模型管理 (`/llm-models`)

#### 5.1 LLM 调用架构

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                           LLM 调用架构 (factory.py)                                      │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                          │
│                       ┌──────────────────────────┐                                      │
│                       │     AIModelService       │                                      │
│                       │    获取激活的模型配置      │                                      │
│                       └────────────┬─────────────┘                                      │
│                                    │                                                     │
│              ┌─────────────────────┼─────────────────────┐                              │
│              ▼                     ▼                     ▼                              │
│  ┌───────────────────┐  ┌───────────────────┐  ┌───────────────────┐                   │
│  │ get_langchain_llm │  │  get_crewai_llm   │  │ get_lite_task_llm │                   │
│  │   (Chat Agent)    │  │   (骨架生成)       │  │  (工具内部调用)    │                   │
│  └─────────┬─────────┘  └─────────┬─────────┘  └─────────┬─────────┘                   │
│            │                      │                      │                              │
│            └──────────────────────┼──────────────────────┘                              │
│                                   ▼                                                      │
│            ┌──────────────────────────────────────────────────────┐                     │
│            │                 provider_type 分流                    │                     │
│            └───────────────────┬──────────────────────────────────┘                     │
│                                │                                                         │
│              ┌─────────────────┴─────────────────┐                                      │
│              ▼                                   ▼                                      │
│   ┌─────────────────────────┐       ┌─────────────────────────┐                        │
│   │     LiteLLM 模式        │       │    自定义网关模式         │                        │
│   │ • OpenAI               │       │ • CustomGatewayLLM      │                        │
│   │ • Ollama               │       │ • NewAPI 等网关          │                        │
│   │ • Azure OpenAI         │       │ • 自定义 endpoint        │                        │
│   └─────────────────────────┘       └─────────────────────────┘                        │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

### 6. 文档中心 (`/doc-center`)

文档中心用于将“帮助中心/企业资料”的目录结构与文档内容同步到本地数据库，并将选中的文档内容索引进 LightRAG，以供 `opdoc_qa` 进行检索问答。

核心能力：

- **结构同步**：拉取目录结构与文档列表
- **内容同步**：下载文档 Markdown，并对图片进行处理/增强
- **索引入库**：将文档内容索引到 LightRAG（workspace: `opdoc`），支持后续混合检索

相关入口：

- 后端 API：`backend/app/api/v1/doc_center.py`
- 索引服务：`backend/app/services/lightrag_index_service.py`
- 前端页面：`frontend/src/pages/DocCenterPage.tsx`

---

## 📊 数据模型

### 核心实体

```
Business (业务流程)
    │
    ├── 1:N ──→ Step (业务步骤)
    │              │
    │              └── N:M ──→ Implementation (技术实现/接口)
    │                              │
    │                              └── N:M ──→ DataResource (数据资源/表)
    │
    └── ProcessStepEdge (步骤流转边)
```

| 实体               | 主键            | 说明                    |
|------------------|---------------|-----------------------|
| `Business`       | `process_id`  | 业务流程，包含名称、渠道、描述、同步状态  |
| `Step`           | `step_id`     | 业务步骤，如"用户提交申请"、"风控审核" |
| `Implementation` | `impl_id`     | 技术实现/接口，如 API、定时任务    |
| `DataResource`   | `resource_id` | 数据资源，如数据库表、缓存         |

### 关系类型

| 关系                           | 说明              |
|------------------------------|-----------------|
| `ProcessStepEdge`            | 步骤之间的流转顺序       |
| `StepImplementation`         | 步骤与实现的关联        |
| `ImplementationDataResource` | 实现对数据资源的访问（读/写） |
| `ImplementationLink`         | 实现之间的调用关系       |

---

## 🔧 技术栈

### 后端

| 组件     | 技术                    | 说明                  |
|--------|-----------------------|---------------------|
| Web 框架 | FastAPI               | 异步 REST + WebSocket |
| ORM    | SQLAlchemy 2.0        | SQLite 元数据存储        |
| 图数据库   | Neo4j 5.x             | 知识图谱存储与查询           |
| LLM 框架 | LangChain + LangGraph | Agent 编排 & 多轮对话     |
| 骨架生成   | CrewAI                | Multi-Agent 协作      |
| LLM 调用 | LiteLLM + 自定义网关       | 多模型统一接口             |
| 代码检索   | MCP (acemcp)          | 代码级语义检索             |
| 日志     | Loguru                | 服务器日志               |

### 前端

| 组件       | 技术                          | 说明          |
|----------|-----------------------------|-------------|
| 框架       | React 18 + TypeScript       | 类型安全的 UI 开发 |
| 构建工具     | Vite 5                      | 快速开发与构建     |
| UI 组件库   | Ant Design 5                | 企业级组件       |
| 流程图      | @xyflow/react               | 可视化画布编辑     |
| Markdown | @uiw/react-markdown-preview | 对话内容渲染      |
| 路由       | React Router 6              | SPA 路由管理    |

---

## 🗂️ 项目结构

```
graph_knowledge/
├── backend/
│   ├── app/
│   │   ├── api/v1/                    # REST & WebSocket 接口
│   │   │   ├── llm_chat.py            # 对话 WebSocket
│   │   │   ├── llm_skeleton.py        # 骨架生成 WebSocket
│   │   │   ├── llm_models.py          # LLM 模型管理
│   │   │   ├── graph.py               # 图查询 API
│   │   │   ├── canvas.py              # 画布保存
│   │   │   ├── processes.py           # 业务流程 CRUD
│   │   │   ├── resource_nodes.py      # 资源节点管理
│   │   │   ├── files.py               # 文件上传
│   │   │   ├── coding.py              # Coding 平台对接
│   │   │   ├── testing.py             # 测试 API
│   │   │   └── health.py              # 健康检查
│   │   ├── llm/                       # LLM 相关
│   │   │   ├── factory.py             # LLM 实例工厂
│   │   │   ├── config.py              # 提供商配置
│   │   │   ├── adapters/              # LLM 适配器
│   │   │   │   ├── crewai_gateway.py  # CrewAI 网关适配
│   │   │   │   └── langchain_patched.py
│   │   │   ├── langchain/             # LangChain Agent
│   │   │   │   ├── registry.py        # Agent 注册表
│   │   │   │   ├── agent.py
│   │   │   │   ├── configs.py         # Agent 配置 & Prompt
│   │   │   │   └── tools/             # 工具模块化
│   │   │   │       ├── discovery.py   # 实体发现 (4)
│   │   │   │       ├── context.py     # 上下文获取 (3)
│   │   │   │       ├── impact.py      # 影响面分析 (2)
│   │   │   │       ├── graph.py       # 图拓扑 (2)
│   │   │   │       ├── code.py        # 代码检索 (5)
│   │   │   │       ├── log.py         # 日志查询
│   │   │   │       ├── db.py          # 数据库查询
│   │   │   │       └── testing.py     # 测试工具
│   │   │   └── crewai/                # CrewAI 骨架生成
│   │   │       ├── agents.py          # Agent 工厂
│   │   │       ├── tasks.py           # Task 定义
│   │   │       ├── prompts.py         # Prompt 模板
│   │   │       └── streaming.py       # 流式输出
│   │   ├── models/                    # SQLAlchemy 数据模型
│   │   │   ├── resource_graph.py      # Business/Step/Impl/Resource
│   │   │   ├── chat.py                # 会话历史
│   │   │   └── ai_models.py           # AI 模型配置
│   │   ├── services/                  # 业务逻辑层
│   │   │   ├── chat/                  # 对话服务
│   │   │   │   ├── chat_service.py    # 流式对话编排
│   │   │   │   ├── history_service.py # 会话历史管理
│   │   │   │   ├── document_parser.py # 文档解析
│   │   │   │   └── multimodal.py      # 多模态处理
│   │   │   ├── skeleton/              # 骨架生成
│   │   │   │   └── skeleton_service.py
│   │   │   ├── storage/               # 文件存储
│   │   │   ├── graph_service.py       # Neo4j 图查询
│   │   │   ├── graph_sync_service.py  # SQLite→Neo4j 同步
│   │   │   ├── canvas_service.py      # 画布数据处理
│   │   │   ├── resource_node_service.py
│   │   │   ├── ai_model_service.py    # LLM 模型管理
│   │   │   └── coding_service.py      # Coding 平台对接
│   │   ├── db/                        # 数据库连接
│   │   │   ├── sqlite.py
│   │   │   └── neo4j_client.py
│   │   └── main.py                    # FastAPI 入口
│   ├── mcp/                           # MCP 代码检索
│   │   ├── ace_code_engine.py
│   │   └── base.py
│   └── requirements.txt
│
├── frontend/
│   ├── src/
│   │   ├── pages/                     # 页面组件
│   │   │   ├── ChatPage.tsx           # AI 对话页面
│   │   │   ├── BusinessLibraryPage.tsx # 业务画布编辑器
│   │   │   ├── StepLibraryPage.tsx
│   │   │   ├── ImplementationLibraryPage.tsx
│   │   │   ├── DataResourceLibraryPage.tsx
│   │   │   ├── ResourceLibraryPage.tsx
│   │   │   ├── LLMModelManagePage.tsx
│   │   │   └── HomePage.tsx
│   │   ├── api/                       # API 封装
│   │   ├── components/                # 通用组件
│   │   │   ├── chat/                  # ChatPage 拆分组件
│   │   │   ├── SkeletonGenerateModal.tsx
│   │   │   └── ...
│   │   ├── hooks/                     # 自定义 Hooks
│   │   ├── types/                     # 类型定义
│   │   ├── utils/                     # 工具函数
│   │   └── styles/
│   └── package.json
│
└── test/                              # 测试脚本
```

---

## 🚀 快速开始

### 环境要求

- Python 3.10+
- Node.js 18+
- Neo4j 5.x（可选，用于图查询增强）

### 1. 后端启动

```bash
cd backend

# 创建虚拟环境
python -m venv .venv
.venv\Scripts\activate  # Windows
# source .venv/bin/activate  # Linux/Mac

# 安装依赖
pip install uv
uv pip install -r requirements.txt

# 启动服务
python -m app.main
# 或直接运行 main.py
```

后端默认运行在 `http://localhost:8000`

### 2. 前端启动

```bash
cd frontend

# 安装依赖
npm install

# 开发模式
npm run dev
```

前端默认运行在 `http://localhost:5173`

### 3. MCP 代码检索服务（可选）

```bash
# 安装 acemcp
uv tool install acemcp

# acemcp 会在后端调用时自动启动
```

### 4. Neo4j 配置（可选）

当前默认连接云端 Neo4j 实例。如需本地部署：

1. 安装 Neo4j Desktop 或 Docker 版本
2. 修改 `backend/app/db/neo4j_client.py` 中的连接配置

### 5. LLM 配置

启动后访问前端 **LLM 模型管理** 页面配置模型：

| 模式          | 配置示例                                     |
|-------------|------------------------------------------|
| **LiteLLM** | `openai/gpt-4o-mini`、`ollama/qwen2.5:7b` |
| **自定义网关**   | 配置 `gateway_endpoint` 指向 NewAPI 等网关      |

### 6. 永策Pro智能助手（`opdoc_qa`）（可选）

`opdoc_qa` 依赖文档中心同步并索引企业知识库（LightRAG workspace: `opdoc`）。如不使用永策Pro智能助手，可跳过。

1. 启动前后端后，访问前端页面 `http://localhost:5173/doc-center`
2. 在文档中心先执行“同步结构”，再对需要的文档执行“同步内容”
3. 在管理模式中选中文档，提交索引任务并等待索引完成
4. 回到 `/chat`，在 Agent 选择器中选择 **永策Pro智能助手** 开始对话

LightRAG 相关配置位于 `backend/app/core/lightrag_config.py`。
